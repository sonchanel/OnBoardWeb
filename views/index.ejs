<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang chủ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body { display: flex; }
        .sidebar { width: 250px; background: #0d6efd; color: white; min-height: 100vh; padding: 15px; }
        .sidebar a { color: white; text-decoration: none; display: block; padding: 10px; }
        .sidebar a:hover { background: #084298; }
        .content { flex-grow: 1; padding: 20px; }
        .filter-panel { width: 250px; padding: 20px; background: #f8f9fa; }
        .status-badge { padding: 5px 10px; border-radius: 5px; color: blue; }
    </style>
</head>
<body>
    <div class="sidebar">
        <h4>
            <a href="/users/Profile" class="text-white text-decoration-none">
                <%= user.name %>
            </a>
        </h4>        
        <a href="/">Trang chủ</a>
        <a href="#">Thông báo</a>
        <a href="/Thanhvien">Thành viên nhóm</a>
        <a href="/Quytrinh">Quy trình</a>
        <a href="#">Cài đặt</a>
    </div>
    
    <div class="content">
        <h2>Trang chủ</h2>
        <form method="get" class="row g-2 mb-3">
            <div class="col-sm-6 col-md-5 col-lg-4">
                <input type="text" class="form-control" name="q" placeholder="Tìm theo tên hoặc email" value="<%= typeof q !== 'undefined' ? q : '' %>">
            </div>
            <div class="col-sm-4 col-md-3 col-lg-3">
                <select class="form-select" name="group" onchange="this.form.submit()">
                    <option value="all" <%= (selectedGroup === 'all') ? 'selected' : '' %>>Tất cả nhóm</option>
                    <% if (typeof groups !== 'undefined' && groups && groups.length) { %>
                        <% groups.forEach(function(g) { %>
                            <option value="<%= g %>" <%= (selectedGroup === g) ? 'selected' : '' %>><%= g %></option>
                        <% }) %>
                    <% } %>
                </select>
            </div>
            <div class="col-sm-2 col-md-2 col-lg-2">
                <button type="submit" class="btn btn-outline-primary w-100">Tìm kiếm</button>
            </div>
            <div class="col-sm-12 col-md-2 col-lg-2">
                <a href="/" class="btn btn-outline-secondary w-100">Xóa lọc</a>
            </div>
            <div class="col-sm-12 col-md-12 col-lg-4 p-1 justify-content-end gap-2">
                <button type="button" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#exportExcelModal">Xuất Excel nhóm</button>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#bulkAssignModal">Gán quy trình hàng loạt</button>
            </div>
        </form>

        <!-- Modal: Gán quy trình hàng loạt -->
        <div class="modal fade" id="bulkAssignModal" tabindex="-1" aria-labelledby="bulkAssignModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="bulkAssignModalLabel">Gán quy trình hàng loạt</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Chọn quy trình</label>
                            <select id="modalProcessSelect" class="form-select">
                                <option value="">-- Chọn quy trình --</option>
                                <% processes.forEach(function(p){ %>
                                    <option value="<%= p._id %>"><%= p.name %></option>
                                <% }) %>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Chọn nhóm</label>
                            <select id="modalGroupSelect" class="form-select">
                                <option value="">-- Chọn nhóm --</option>
                                <% if (typeof groups !== 'undefined' && groups && groups.length) { %>
                                    <% groups.forEach(function(g) { %>
                                        <option value="<%= g %>"><%= g %></option>
                                    <% }) %>
                                <% } %>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                        <button type="button" class="btn btn-primary" onclick="assignProcessToGroupFromModal()">Gán</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal: Xuất Excel câu trả lời form theo nhóm -->
        <div class="modal fade" id="exportExcelModal" tabindex="-1" aria-labelledby="exportExcelModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exportExcelModalLabel">Xuất Excel câu trả lời form</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Chọn nhóm</label>
                            <select id="exportGroupSelect" class="form-select">
                                <option value="">-- Chọn nhóm --</option>
                                <% if (typeof groups !== 'undefined' && groups && groups.length) { %>
                                    <% groups.forEach(function(g) { %>
                                        <option value="<%= g %>" <%= (selectedGroup === g) ? 'selected' : '' %>><%= g %></option>
                                    <% }) %>
                                <% } %>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                        <button type="button" class="btn btn-success" onclick="exportExcelByGroup()">Tải xuống</button>
                    </div>
                </div>
            </div>
        </div>
        
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Tên</th>
                    <th>Email</th>
                    <th>Cập nhật</th>
                    <th>Nhóm</th>
                    <th>Người quản lý</th>
                    <th>Quy trình</th>
                    <th>Trạng thái</th>
                    <th>Thao tác</th>
                </tr>
            </thead>
            <tbody>
                <% data.forEach((item, index) => { %>
                <tr>
                    <td><%= index + 1 %></td>
                    <td><%= item.name %></td>
                    <td><%= item.email %></td>
                    <td><%= item.updatedAt ? new Date(item.updatedAt).toLocaleString('vi-VN') : "Chưa cập nhật"%></td>
                    <td><%= item.group %></td>
                    <td><%= user.name %></td>
                    <td>
                        <% if(item.quyTrinhName.length > 0){ %>
                            <%= item.quyTrinhName %>  
                        <% } else { %>         
                            <span style="color: cadetblue;">Chưa có</span>
                        <% } %>
                    </td>
                    <td>
                        <span class="status-badge"><%= item.status %></span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="openProcessModal('<%= item._id %>')">Thêm quy trình</button>
                        <!-- <button class="btn btn-sm btn-warning" onclick="editItem('<%= item._id %>')">Chỉnh sửa</button> -->
                        <!-- <button class="btn btn-sm btn-danger" onclick="formUser('<%= item._id %>')">Form</button> -->
                        <a class="btn btn-sm btn-primary" href="/Form/<%= item._id %>">
                            <i class="fas fa-eye"></i> Form
                          </a>                          
                    </td>                    
                </tr>
                <% }); %>
            </tbody>
        </table>
    </div>

<!-- Modal chọn quy trình -->
<div class="modal fade" id="processModal" tabindex="-1" aria-labelledby="processModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="processModalLabel">Chọn quy trình</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <ul id="processList" class="list-group">
                    <% processes.forEach(process => { %>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span><%= process.name %></span>
                            <button class="btn btn-sm btn-primary" onclick="addProcess('<%= process._id %>')">Thêm</button>
                        </li>
                    <% }); %>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>


    
    <!-- <div class="filter-panel">
        <h5>Trạng thái</h5>
        <ul class="list-unstyled">
            <li><input type="radio" name="status" checked> Tất cả</li>
            <li><input type="radio" name="status"> Chờ onboard</li>
            <li><input type="radio" name="status"> Đang onboard</li>
            <li><input type="radio" name="status"> Kiểm tra</li>
            <li><input type="radio" name="status"> Sẵn sàng</li>
            <li><input type="radio" name="status"> Hoàn thành</li>
        </ul>
    </div> -->
</body>

<script>
    let selectedUserId = null;

    function openProcessModal(userId) {
        selectedUserId = userId;
        let modal = new bootstrap.Modal(document.getElementById('processModal'));
        modal.show();
    }

    function addProcess(processId) {
        fetch(`/assign-process/${selectedUserId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ processId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert("Đã thêm quy trình thành công!");
                window.location.reload();
            } else {
                alert(data.message);
            }
        });
    }

    function exportExcelByGroup(){
        const group = document.getElementById('exportGroupSelect').value;
        if(!group){
            alert('Hãy chọn nhóm.');
            return;
        }
        // Tải file bằng cách mở URL (GET download)
        const url = `/export-form-answers?group=${encodeURIComponent(group)}`;
        window.location.href = url;
    }

    function assignProcessToGroupFromModal() {
        const processId = document.getElementById('modalProcessSelect').value;
        const group = document.getElementById('modalGroupSelect').value;

        if (!group) {
            alert('Hãy chọn nhóm.');
            return;
        }
        if (!processId) {
            alert('Hãy chọn quy trình.');
            return;
        }

        fetch('/assign-process-group', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ group, processId })
        })
        .then(r => r.json())
        .then(res => {
            if (res.success) {
                alert(res.message || 'Đã gán quy trình cho nhóm');
                window.location.reload();
            } else {
                alert(res.message || 'Có lỗi xảy ra');
            }
        })
        .catch(() => alert('Có lỗi xảy ra'))
    }
</script>

    
</html>
