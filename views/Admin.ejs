<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Quản lý tài khoản</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body { display: flex; }
        .sidebar { width: 250px; background: #0d6efd; color: white; min-height: 100vh; padding: 15px; }
        .sidebar a { color: white; text-decoration: none; display: block; padding: 10px; }
        .sidebar a:hover { background: #084298; }
        .content { flex-grow: 1; padding: 20px; }
        .info-group { margin-bottom: 10px; }
        .info-label { font-weight: bold; }
    </style>
</head>
<body>
    <div class="content">
        <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex gap-2">
                <button class="btn btn-outline-secondary" onclick="showProfileView()">Hồ sơ</button>
                <button class="btn btn-outline-primary" onclick="showManagerView()">Danh sách Quản lý</button>
            </div>
        </div>

        <div id="profileSection" class="d-none">
        <h2 class="mb-3">Hồ sơ Admin</h2>
        <button class="btn btn-warning mb-3" id="changePassBtn" onclick="toggleChangePass(true)">Đổi mật khẩu</button>
        <button class="btn btn-primary mb-3" id="editBtn" onclick="toggleEdit(true)">Chỉnh sửa</button>
        <button class="btn btn-success mb-3 d-none" id="saveBtn" onclick="saveChanges('<%= user._id %>')">Lưu</button>
        <button class="btn btn-danger mb-3" onclick="logout()">Đăng xuất</button>
        <div id="profileInfo" class="mb-4">
            <div class="info-group"><span class="info-label">Họ và tên:</span> <span id="name"><%= user.name %></span></div>
            <div class="info-group"><span class="info-label">Email:</span> <span id="email"><%= user.email %></span></div>
            <div class="info-group"><span class="info-label">Số điện thoại:</span> <span id="phone"><%= user.phone || '' %></span></div>
            <div class="info-group"><span class="info-label">Địa chỉ:</span> <span id="address"><%= user.address || '' %></span></div>
            <div class="info-group"><span class="info-label">Vai trò:</span> <span>Admin</span></div>
            <div class="info-group"><span class="info-label">Ngày tham gia:</span> <span><%= new Date(user.createdAt).toLocaleDateString('vi-VN') || '' %></span></div>
        </div>

        <div id="changePassFields" class="d-none mb-3">
            <div class="form-group mb-2">
                <label>Mật khẩu hiện tại:</label>
                <input type="password" id="currentPassword" class="form-control">
            </div>
            <div class="form-group mb-2">
                <label>Mật khẩu mới:</label>
                <input type="password" id="newPassword" class="form-control">
            </div>
            <div class="form-group mb-3">
                <label>Xác nhận mật khẩu:</label>
                <input type="password" id="confirmPassword" class="form-control">
            </div>
            <button class="btn btn-success" id="savePassBtn" onclick="saveNewPassword('<%= user._id %>')">Lưu mật khẩu</button>
            <button class="btn btn-secondary ms-2" onclick="cancelChangePassword()">Huỷ</button>
        </div>
        </div>

        <div id="managerSection">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <h3 class="mb-0">Danh sách Quản lý</h3>
                <small class="text-muted">Đăng nhập: <strong><%= user.name %></strong> - <%= user.email %></small>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createModal">+ Thêm quản lý</button>
            </div>
        </div>

        <form method="get" class="row g-2 mb-3">
            <div class="col-sm-8 col-md-6 col-lg-5">
                <input type="text" class="form-control" name="q" placeholder="Tìm theo tên hoặc email" value="<%= q %>">
            </div>
            <div class="col-sm-4 col-md-2 col-lg-2">
                <button type="submit" class="btn btn-outline-primary w-100">Tìm kiếm</button>
            </div>
            <div class="col-sm-12 col-md-2 col-lg-2">
                <a href="/Admin" class="btn btn-outline-secondary w-100">Xóa lọc</a>
            </div>
        </form>

        <table class="table table-striped">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Tên</th>
                    <th>Email</th>
                    <th>Thời gian tạo</th>
                    <th>Thao tác</th>
                </tr>
            </thead>
            <tbody>
                <% managers.forEach((m, idx) => { %>
                <tr>
                    <td><%= idx + 1 %></td>
                    <td><%= m.name %></td>
                    <td><%= m.email %></td>
                    <td><%= new Date(m.createdAt).toLocaleString('vi-VN') %></td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="openEdit('<%= m._id %>')">Sửa</button>
                        <button class="btn btn-sm btn-danger" onclick="removeManager('<%= m._id %>')">Xóa</button>
                    </td>
                </tr>
                <% }) %>
            </tbody>
        </table>
    </div>

    <!-- Modal tạo -->
    <div class="modal fade" id="createModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Thêm tài khoản Quản lý</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="createForm">
                        <div class="mb-3">
                            <label class="form-label">Tên</label>
                            <input class="form-control" id="c_name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input class="form-control" id="c_email" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Mật khẩu</label>
                            <input class="form-control" id="c_password" required>
                        </div>
                        <button class="btn btn-success" type="submit">Lưu</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    

    <!-- Modal sửa -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Cập nhật Quản lý</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editForm">
                        <input type="hidden" id="e_id">
                        <div class="mb-3">
                            <label class="form-label">Tên</label>
                            <input class="form-control" id="e_name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input class="form-control" id="e_email" required>
                        </div>
                        <button class="btn btn-success" type="submit">Cập nhật</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal cập nhật thông tin của tôi -->
    <div class="modal fade" id="updateMeModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Cập nhật thông tin</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="updateMeForm">
                        <div class="mb-3">
                            <label class="form-label">Tên</label>
                            <input class="form-control" id="me_name" value="<%= user.name %>" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input class="form-control" id="me_email" value="<%= user.email %>" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Số điện thoại</label>
                            <input class="form-control" id="me_phone" value="<%= user.phone || '' %>">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Địa chỉ</label>
                            <input class="form-control" id="me_address" value="<%= user.address || '' %>">
                        </div>
                        <button class="btn btn-success" type="submit">Lưu</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal đổi mật khẩu -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Đổi mật khẩu</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="changePasswordForm">
                        <div class="mb-3">
                            <label class="form-label">Mật khẩu hiện tại</label>
                            <input type="password" class="form-control" id="me_current_password" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Mật khẩu mới</label>
                            <input type="password" class="form-control" id="me_new_password" required>
                        </div>
                        <button class="btn btn-warning" type="submit">Đổi mật khẩu</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

<script>
document.getElementById('createForm').addEventListener('submit', async function(e){
    e.preventDefault();
    const payload = {
        name: document.getElementById('c_name').value,
        email: document.getElementById('c_email').value,
        password: document.getElementById('c_password').value
    };
    const res = await fetch('/Admin/create', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
    if(res.ok){
        alert('Tạo thành công');
        window.location.reload();
    } else {
        const err = await res.json();
        alert(err.message || 'Có lỗi xảy ra');
    }
});

async function openEdit(id){
    const res = await fetch(`/Admin/${id}`);
    const m = await res.json();
    document.getElementById('e_id').value = m._id;
    document.getElementById('e_name').value = m.name;
    document.getElementById('e_email').value = m.email;
    new bootstrap.Modal(document.getElementById('editModal')).show();
}

document.getElementById('editForm').addEventListener('submit', async function(e){
    e.preventDefault();
    const id = document.getElementById('e_id').value;
    const payload = {
        name: document.getElementById('e_name').value,
        email: document.getElementById('e_email').value
    };
    const res = await fetch(`/Admin/update/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
    if(res.ok){
        alert('Cập nhật thành công');
        window.location.reload();
    } else {
        alert('Có lỗi xảy ra');
    }
});

async function removeManager(id){
    if(confirm('Bạn có chắc muốn xóa tài khoản này?')){
        const res = await fetch(`/Admin/delete/${id}`, { method: 'DELETE' });
        if(res.ok){
            alert('Đã xóa');
            window.location.reload();
        } else {
            alert('Có lỗi xảy ra');
        }
    }
}



function openUpdateMe(){
    new bootstrap.Modal(document.getElementById('updateMeModal')).show();
}

function openChangePassword(){
    new bootstrap.Modal(document.getElementById('changePasswordModal')).show();
}

document.getElementById('updateMeForm')?.addEventListener('submit', async function(e){
    e.preventDefault();
    const payload = {
        name: document.getElementById('me_name').value,
        email: document.getElementById('me_email').value,
        phone: document.getElementById('me_phone').value,
        address: document.getElementById('me_address').value
    };
    const res = await fetch('/users/update/<%= user._id %>', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
    if(res.ok){
        alert('Cập nhật thành công');
        window.location.reload();
    } else {
        const err = await res.json();
        alert(err.error || 'Có lỗi xảy ra');
    }
});

document.getElementById('changePasswordForm')?.addEventListener('submit', async function(e){
    e.preventDefault();
    const payload = {
        currentPassword: document.getElementById('me_current_password').value,
        newPassword: document.getElementById('me_new_password').value
    };
    const res = await fetch('/users/change-password/<%= user._id %>', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
    if(res.ok){
        alert('Đổi mật khẩu thành công');
        document.getElementById('me_current_password').value = '';
        document.getElementById('me_new_password').value = '';
        bootstrap.Modal.getInstance(document.getElementById('changePasswordModal')).hide();
    } else {
        const err = await res.json();
        alert(err.error || 'Có lỗi xảy ra');
    }
});

async function logout(){
    const res = await fetch('/users/logout', { method: 'POST' });
    if(res.ok){
        window.location.href = '/Dangnhap';
    } else {
        alert('Đăng xuất thất bại');
    }
}
</script>

<script>
    function toggleChangePass(show) {
        document.getElementById('changePassFields').classList.toggle('d-none', !show);
        document.getElementById('changePassBtn').classList.toggle('d-none', show);
    }

    function cancelChangePassword() {
        toggleChangePass(false);
        document.getElementById('currentPassword').value = '';
        document.getElementById('newPassword').value = '';
        document.getElementById('confirmPassword').value = '';
    }

    function toggleEdit(editMode) {
        document.getElementById('editBtn').classList.toggle('d-none', editMode);
        document.getElementById('saveBtn').classList.toggle('d-none', !editMode);
        let fields = { name: { type: 'text' }, email: { type: 'email' }, phone: { type: 'tel' }, address: { type: 'text' } };
        for (let field in fields) {
            let span = document.getElementById(field);
            let value = span.innerText;
            span.outerHTML = editMode
                ? `<input type='${fields[field].type}' id='${field}' value='${value}' class='form-control'>`
                : `<span id='${field}'>${value}</span>`;
        }
    }

    function showProfileView(){
        document.getElementById('managerSection').classList.add('d-none');
        document.getElementById('profileSection').classList.remove('d-none');
    }

    function showManagerView(){
        document.getElementById('profileSection').classList.add('d-none');
        document.getElementById('managerSection').classList.remove('d-none');
    }

    function saveChanges(id) {
        let data = {
            name: document.getElementById('name').value,
            email: document.getElementById('email').value,
            phone: document.getElementById('phone').value,
            address: document.getElementById('address').value
        };
        fetch(`/users/update/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) })
            .then(response => { if (!response.ok) { throw new Error('Cập nhật thất bại'); } return response.json(); })
            .then(updatedUser => {
                alert('Cập nhật thành công!');
                toggleEdit(false);
                document.getElementById('name').innerText = updatedUser.name;
                document.getElementById('email').innerText = updatedUser.email;
                document.getElementById('phone').innerText = updatedUser.phone || '';
                document.getElementById('address').innerText = updatedUser.address || '';
            })
            .catch(err => alert(err.message));
    }

    function logout() {
        fetch('/users/logout', { method: 'POST' })
            .then(response => { if (response.ok) { window.location.href = '/Dangnhap'; } else { alert('Đăng xuất thất bại!'); } })
            .catch(() => alert('Lỗi kết nối!'));
    }

    function saveNewPassword(userId) {
        const currentPassword = document.getElementById('currentPassword').value.trim();
        const newPassword = document.getElementById('newPassword').value.trim();
        const confirmPassword = document.getElementById('confirmPassword').value.trim();
        const strongPassword = /^(?=.*[A-Z])(?=.*\d).{8,}$/;
        if (!currentPassword || !newPassword || !confirmPassword) { alert('Vui lòng nhập đầy đủ thông tin.'); return; }
        if (newPassword !== confirmPassword) { alert('Mật khẩu xác nhận không khớp.'); return; }
        if (!strongPassword.test(newPassword)) { alert('Mật khẩu phải có ít nhất 8 ký tự, 1 chữ hoa và 1 số.'); return; }
        fetch(`/users/change-password/${userId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ currentPassword, newPassword }) })
            .then(response => { if (!response.ok) throw new Error('Đổi mật khẩu thất bại.'); return response.json(); })
            .then(() => { alert('Đổi mật khẩu thành công!'); cancelChangePassword(); })
            .catch(error => alert(error.message));
    }
</script>

</body>
</html>


