<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hồ sơ cá nhân</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body { display: flex; }
        .sidebar { width: 250px; background-color: #4CAF50; color: white; min-height: 100vh; padding: 15px; }
        .sidebar a { color: white; text-decoration: none; display: block; padding: 10px; }
        .sidebar a:hover {
            background: #24a828; 
        }
        .sidebar.quanly { width: 250px; background: #0d6efd; color: white; height: 100vh; padding: 15px; }
        .sidebar.quanly a:hover { background: #084298; }
        .content { flex-grow: 1; padding: 20px; }
        .info-group { margin-bottom: 15px; }
        .info-label { font-weight: bold; }
        .edit-mode input, .edit-mode textarea { width: 100%; }
    </style>
</head>
<body>
    <div class="sidebar <%= user.role !== 'Nhân viên' ? 'quanly' : '' %>"">
        <h4 id="titlename"><%= user.name %></h4>
        <a href="/">Quay lại</a>
        <!-- <a href="#">Thông báo</a>
        <a href="/Thanhvien">Thành viên nhóm</a>
        <a href="/Quytrinh">Quy trình</a>
        <a href="#">Cài đặt</a> -->
    </div>
    
    <div class="content">
        <h2>Hồ sơ cá nhân</h2>
        <button class="btn btn-warning mb-3" id="changePassBtn" onclick="toggleChangePass(true)">Đổi mật khẩu</button>
        <button class="btn btn-primary mb-3" id="editBtn" onclick="toggleEdit(true)">Chỉnh sửa</button>
        <button class="btn btn-success mb-3 d-none" id="saveBtn" onclick="saveChanges('<%= user._id %>')">Lưu</button>
        <button class="btn btn-danger mb-3" onclick="logout()">Đăng xuất</button>
        
        <div id="profileInfo">
            <div class="info-group"><span class="info-label">Họ và tên:</span> <span id="name"><%= user.name %></span></div>
            <div class="info-group"><span class="info-label">Email:</span> <span id="email"><%= user.email %></span></div>
            <div class="info-group"><span class="info-label">Số điện thoại:</span> <span id="phone"><%= user.phone || '' %></span></div>
            <div class="info-group"><span class="info-label">Địa chỉ:</span> <span id="address"><%= user.address || '' %></span></div>
            <div class="info-group"><span class="info-label">Vai trò:</span> <span><%= user.role || 'Nhân viên' %></span></div>
            <% if(user.group){ %>
            <div class="info-group"><span class="info-label">Nhóm:</span> <span><%= user.group || '' %></span></div>
            <% } %>
            <% if(manager){ %>
            <div class="info-group"><span class="info-label">Quản lý:</span> <span><%= manager.name || '' %></span></div>
            <% } %>
            <div class="info-group"><span class="info-label">Ngày tham gia:</span> <span><%= new Date(user.createdAt).toLocaleDateString('vi-VN') || '' %></span></div>
        </div>
        <div id="changePassFields" class="d-none mb-3">
            <div class="form-group mb-2">
                <label>Mật khẩu hiện tại:</label>
                <input type="password" id="currentPassword" class="form-control">
            </div>
            <div class="form-group mb-2">
                <label>Mật khẩu mới:</label>
                <input type="password" id="newPassword" class="form-control">
            </div>
            <div class="form-group mb-3">
                <label>Xác nhận mật khẩu:</label>
                <input type="password" id="confirmPassword" class="form-control">
            </div>
            <button class="btn btn-success" id="savePassBtn" onclick="saveNewPassword('<%= user._id %>')">Lưu mật khẩu</button>
            <button class="btn btn-secondary ms-2" onclick="cancelChangePassword()">Huỷ</button>
        </div>
        
        

    </div>
    <script>
        function toggleChangePass(show) {
            document.getElementById('changePassFields').classList.toggle('d-none', !show);
            document.getElementById('changePassBtn').classList.toggle('d-none', show);
        }
    
        function cancelChangePassword() {
            toggleChangePass(false);
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        }
    </script>
        
    <script>
        function toggleEdit(editMode) {
            document.getElementById('editBtn').classList.toggle('d-none', editMode);
            document.getElementById('saveBtn').classList.toggle('d-none', !editMode);
            
            let fields = {
                name: { type: 'text' },
                email: { type: 'email' }, // Thay đổi thành input type="email"
                phone: { type: 'tel' }, // Thay đổi thành input type="tel"
                address: { type: 'text' }
            };
    
            for (let field in fields) {
                let span = document.getElementById(field);
                let value = span.innerText;
                span.outerHTML = editMode 
                    ? `<input type='${fields[field].type}' id='${field}' value='${value}' class='form-control'>` 
                    : `<span id='${field}'>${value}</span>`;
            }
        }
        
        function saveChanges(id) {
            let data = {
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                address: document.getElementById('address').value
            };
            
            fetch(`/users/update/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Cập nhật thất bại');
                }
                return response.json(); // Đọc phản hồi JSON
            })
            .then(updatedUser => {
                alert("Cập nhật thành công!");
                toggleEdit(false);
                
                // Cập nhật giao diện với dữ liệu mới
                document.getElementById('titlename').innerText = updatedUser.name;
                document.getElementById('name').innerText = updatedUser.name;
                document.getElementById('email').innerText = updatedUser.email;
                document.getElementById('phone').innerText = updatedUser.phone || '';
                document.getElementById('address').innerText = updatedUser.address || '';
            })
            .catch(error => {
                alert(error.message);
            });            
        }
    </script>
    <script>
        function logout() {
            fetch('/users/logout', { method: 'POST' }) // Gọi API đăng xuất
            .then(response => {
                if (response.ok) {
                    window.location.href = '/Dangnhap'; // Chuyển về trang đăng nhập
                } else {
                    alert("Đăng xuất thất bại!");
                }
            })
            .catch(error => alert("Lỗi kết nối!"));
        }
    </script>
    
    <script>
        function saveNewPassword(userId) {
            const currentPassword = document.getElementById('currentPassword').value.trim();
            const newPassword = document.getElementById('newPassword').value.trim();
            const confirmPassword = document.getElementById('confirmPassword').value.trim();
        
            const strongPassword = /^(?=.*[A-Z])(?=.*\d).{8,}$/;
        
            if (!currentPassword || !newPassword || !confirmPassword) {
                alert("Vui lòng nhập đầy đủ thông tin.");
                return;
            }
        
            if (newPassword !== confirmPassword) {
                alert("Mật khẩu xác nhận không khớp.");
                return;
            }
        
            if (!strongPassword.test(newPassword)) {
                alert("Mật khẩu phải có ít nhất 8 ký tự, 1 chữ hoa và 1 số.");
                return;
            }
        
            fetch(`/users/change-password/${userId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ currentPassword, newPassword })
            })
            .then(response => {
                if (!response.ok) throw new Error('Đổi mật khẩu thất bại.');
                return response.json();
            })
            .then(() => {
                alert("Đổi mật khẩu thành công!");
                toggleChangePass(false);
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
            })
            .catch(error => alert(error.message));
        }
        
    </script>
    
</body>
</html>