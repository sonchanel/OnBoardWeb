<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang ch·ªß</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body { display: flex; }
        .sidebar { width: 250px; background: #0d6efd; color: white; min-height: 100vh; padding: 15px; }
        .sidebar a { color: white; text-decoration: none; display: block; padding: 10px; }
        .sidebar a:hover { background: #084298; }
        .content { flex-grow: 1; padding: 20px; }
        .filter-panel { width: 250px; padding: 20px; background: #f8f9fa; }
        .status-badge { padding: 5px 10px; border-radius: 5px; color: white; }
    </style>
</head>
<body>
    <div class="sidebar">
        <h4>
            <a href="/users/Profile" class="text-white text-decoration-none">
                <%= user.name %>
            </a>
        </h4>        
        <a href="/">Trang ch·ªß</a>
        <a href="#">Th√¥ng b√°o</a>
        <a href="/Thanhvien">Th√†nh vi√™n nh√≥m</a>
        <a href="/Quytrinh">Quy tr√¨nh</a>
        <a href="#">C√†i ƒë·∫∑t</a>
    </div>
    
    <div class="content">
        <h2>Danh s√°ch Quy tr√¨nh</h2>

        <% if (processes.length > 0) { %>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>T√™n quy tr√¨nh</th>
                        <th>Nh√≥m</th>
                        <th>Tr·∫°ng th√°i</th>
                        <!-- <th>T√†i li·ªáu</th> -->
                        <th>Ng√†y t·∫°o</th>
                        <th>Ng∆∞·ªùi t·∫°o</th>
                        <th>Thao taÃÅc</th>
                    </tr>
                </thead>
                <tbody>
                    <% processes.forEach((process, index) => { %>
                        <tr>
                            <td><%= index + 1 %></td>
                            <td><%= process.name %></td>
                            <td><%= process.group %></td>
                            <td><%= process.status %></td>
                            <!-- <td><%= process.document %></td> -->
                            <td><%= process.createdAt ? new Date(process.createdAt).toLocaleDateString('vi-VN') : 'N/A' %></td>
                            <td><%= user.name %></td>
                            <td>
                                <a href="/Quytrinh/<%= process._id %>" class="btn btn-info btn-sm">üîç Chi ti·∫øt</a>
                                <button class="btn btn-danger btn-sm" onclick="deleteProcess('<%= process._id %>')">üóëÔ∏è X√≥a</button>
                            </td>
                        </tr>
                    <% }) %>
                </tbody>
            </table>
        <% } else { %>
            <p class="text-muted">Ch∆∞a c√≥ quy tr√¨nh n√†o.</p>
        <% } %>
        <!-- N√∫t "Th√™m quy tr√¨nh" ·ªü g√≥c ph·∫£i -->
        <button class="btn btn-primary position-absolute top-0 end-0 mt-2 me-3"
        data-bs-toggle="modal" data-bs-target="#addProcessModal">
        + Th√™m quy tr√¨nh
    </button>   
    </div>
        
<!-- Modal nh·∫≠p th√¥ng tin quy tr√¨nh -->
<div class="modal fade" id="addProcessModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">T·∫°o Quy Tr√¨nh M·ªõi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="processForm">
                    <div class="mb-3">
                        <label for="name" class="form-label">T√™n quy tr√¨nh</label>
                        <input type="text" class="form-control" id="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="createdBy" class="form-label">Ng∆∞·ªùi qu·∫£n l√Ω</label>
                        <input type="text" class="form-control" id="createdBy" data="<%= user._id%>" value="<%= user.email%>" disabled>
                    </div>
                    <div class="mb-3">
                        <label for="group" class="form-label">Nh√≥m</label>
                        <input type="text" class="form-control" id="group" required>
                    </div>
                    <!-- <div class="mb-3">
                        <label for="status" class="form-label">Tr·∫°ng th√°i</label>
                        <select class="form-control" id="status">
                            <option value="M·ªõi">M·ªõi</option>
                            <option value="ƒêang th·ª±c hi·ªán">ƒêang th·ª±c hi·ªán</option>
                            <option value="Ho√†n th√†nh">Ho√†n th√†nh</option>
                        </select>
                    </div> -->
                    <button type="submit" class="btn btn-success">L∆∞u</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById("processForm").addEventListener("submit", async function (e) {
    e.preventDefault();
    
    const processData = {
        name: document.getElementById("name").value,
        createdBy: document.getElementById("createdBy").getAttribute("data"),
        group: document.getElementById("group").value,
    };

    const response = await fetch("/Quytrinh/create", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(processData)
    });

    if (response.ok) {
        alert("Th√™m quy tr√¨nh th√†nh c√¥ng!");
        window.location.reload();
    } else {
        alert("C√≥ l·ªói x·∫£y ra!");
    }
});
</script>

<script>
    async function deleteProcess(processId) {
        if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a quy tr√¨nh n√†y?")) return;
    
        const response = await fetch(`/Quytrinh/delete/${processId}`, {
            method: "DELETE",
        });
    
        if (response.ok) {
            alert("Quy tr√¨nh ƒë√£ ƒë∆∞·ª£c x√≥a!");
            window.location.reload();
        } else {
            alert("C√≥ l·ªói x·∫£y ra!");
        }
    }    
</script>

</body>
</html>
